<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Binance Futures Positions – Live (1s)</title>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* 미세한 테이블 스크롤 및 숫자 폰트 최적화 */
    html, body { height: 100%; }
    .num { font-variant-numeric: tabular-nums; }
    .blink {
      animation: blink 0.4s ease;
    }
    @keyframes blink {
      0% { background-color: rgba(34,197,94,.15); }
      100% { background-color: transparent; }
    }
    .blink-neg {
      animation: blinkNeg 0.4s ease;
    }
    @keyframes blinkNeg {
      0% { background-color: rgba(239,68,68,.15); }
      100% { background-color: transparent; }
    }
  </style>
</head>
<body class="bg-slate-950 text-slate-100">
  <div class="max-w-7xl mx-auto p-4 md:p-6">
    <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-semibold">Futures Positions</h1>
      </div>
      <div class="flex items-center gap-3" style="display: none;">
        <div class="px-3 py-1 rounded-lg bg-slate-800 text-xs">
          업데이트 주기: <span class="font-semibold">1s</span>
        </div>
        <div class="px-3 py-1 rounded-lg bg-slate-800 text-xs">
          마지막 업데이트: <span id="lastUpdate" class="font-medium">-</span>
        </div>
        <button id="pauseBtn" class="px-3 py-1 rounded-lg bg-blue-600 hover:bg-blue-500 text-xs font-semibold">
          ⏸ 일시정지
        </button>
      </div>
    </header>

    <section class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="p-4 rounded-2xl bg-slate-900 shadow">
        <div class="text-slate-400 text-sm">총 미실현손익 (USD)</div>
        <div id="totalUpl" class="mt-1 text-3xl md:text-4xl font-bold num">–</div>
      </div>
      <div class="p-4 rounded-2xl bg-slate-900 shadow">
        <div class="text-slate-400 text-sm">총 포지션 명목가치</div>
        <div id="totalNotionalAbs" class="mt-1 text-3xl md:text-4xl font-bold num">–</div>
      </div>
      <div class="p-4 rounded-2xl bg-slate-900 shadow">
        <div class="text-slate-400 text-sm">포지션 수</div>
        <div id="positionsCount" class="mt-1 text-3xl md:text-4xl font-bold num">–</div>
      </div>
    </section>

    <section class="mt-6">
      <div class="overflow-auto rounded-2xl border border-slate-800">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-900/60 sticky top-0">
            <tr class="text-slate-300">
              <th class="px-4 py-3 text-left">심볼</th>
              <th class="px-4 py-3 text-right">수량</th>
              <th class="px-4 py-3 text-right">진입가</th>
              <th class="px-4 py-3 text-right">마크프라이스</th>
              <th class="px-4 py-3 text-right">레버리지</th>
              <th class="px-4 py-3 text-right">격리</th>
              <th class="px-4 py-3 text-right">명목</th>
              <!-- <th class="px-4 py-3 text-right">U PnL(소스)</th> -->
              <th class="px-4 py-3 text-right">U PnL</th>
              <!-- <th class="px-4 py-3 text-right">Funding / Index</th>
              <th class="px-4 py-3 text-right">업데이트</th> -->
            </tr>
          </thead>
          <tbody id="tbody" class="divide-y divide-slate-800 bg-slate-950"></tbody>
        </table>
      </div>
      <!-- <p class="mt-2 text-xs text-slate-500">
        * U PnL(계산)은 Binance 마크프라이스 기준으로 (mark - entry) × 수량 으로 계산합니다. (숫자는 반올림 표시)
      </p> -->
    </section>
  </div>

  <script>
    const SKYEDGE_URL = "https://pos.skyedge.kr/positions";
    // Binance USDⓈ-M Futures public API (USDT/BUSD/USDC 통합)
    const BINANCE_PREMIUM_INDEX = "https://fapi.binance.com/fapi/v1/premiumIndex"; // ?symbol=BTCUSDC
    // 포맷터
    const nf2 = new Intl.NumberFormat('en-US', { maximumFractionDigits: 2 });
    const nf4 = new Intl.NumberFormat('en-US', { maximumFractionDigits: 4 });
    const nf8 = new Intl.NumberFormat('en-US', { maximumFractionDigits: 8 });
    const cFmt = (v) => {
      const sign = v > 0 ? '+' : v < 0 ? '−' : '';
      const abs = Math.abs(v);
      const digits = abs >= 100 ? 2 : abs >= 1 ? 4 : 8;
      return sign + new Intl.NumberFormat('en-US', { maximumFractionDigits: digits }).format(abs);
    };
    const usd = (v, digits = 2) => {
      return (v < 0 ? '-' : '') + '$' + new Intl.NumberFormat('en-US', { maximumFractionDigits: digits }).format(Math.abs(v));
    };
    const pct = (v) => {
      return (v >= 0 ? '+' : '') + new Intl.NumberFormat('en-US', { maximumFractionDigits: 4 }).format(v * 100) + '%';
    };

    let timer = null;
    let paused = false;
    const pauseBtn = document.getElementById('pauseBtn');
    pauseBtn.addEventListener('click', () => {
      paused = !paused;
      pauseBtn.textContent = paused ? '▶ 재개' : '⏸ 일시정지';
      if (!paused) tick(); // 즉시 한 번 갱신
    });

    // Binance에서 심볼별 프리미엄/마크 가격/펀딩 정보를 가져오기
    async function fetchBinanceFor(symbol) {
      // 심볼 예: BTCUSDC, ETHUSDC, SOLUSDC …
      const url = `${BINANCE_PREMIUM_INDEX}?symbol=${encodeURIComponent(symbol)}`;
      const r = await fetch(url);
      if (!r.ok) throw new Error(`Binance error ${r.status}`);
      return r.json(); // { markPrice, indexPrice, lastFundingRate, nextFundingTime, ... }
    }

    // Skyedge + Binance 결합 갱신
    async function tick() {
      if (paused) return;
      try {
        const r = await fetch(SKYEDGE_URL, { cache: "no-store" });
        if (!r.ok) throw new Error(`Skyedge error ${r.status}`);
        const data = await r.json();

        const positions = Array.isArray(data.positions) ? data.positions.slice() : [];
        // 큰 포지션이 위로 오도록 정렬 (절대 명목값 desc)
        positions.sort((a, b) => Math.abs(b.notional || 0) - Math.abs(a.notional || 0));

        // Binance 데이터 병렬 요청
        const symbols = positions.map(p => p.symbol);
        const uniqueSymbols = Array.from(new Set(symbols));
        const binanceMap = {};
        await Promise.all(uniqueSymbols.map(async (sym) => {
          try {
            const b = await fetchBinanceFor(sym);
            binanceMap[sym] = b;
          } catch (e) {
            // 실패 시 빈 객체로
            binanceMap[sym] = null;
            console.warn('Binance fetch failed for', sym, e);
          }
        }));

        render(data, positions, binanceMap);
      } catch (e) {
        console.error(e);
      } finally {
        // 1초 주기
        clearTimeout(timer);
        timer = setTimeout(() => tick(), 1000);
      }
    }

    function render(src, positions, binanceMap) {
      const tbody = document.getElementById('tbody');

      // 상단 카드 업데이트
      document.getElementById('positionsCount').textContent = positions.length;
      // 총 미실현손익: (mark - entry) * qty 합계를 실시간 계산
      const totalUplCalc = positions.reduce((acc, p) => {
        const m = +(binanceMap[p.symbol]?.markPrice ?? p.markPrice ?? 0);
        const e = +p.entryPrice;
        const q = +p.positionAmt;
        return acc + (m - e) * q;
      }, 0);
      const totalUplEl = document.getElementById('totalUpl');
      totalUplEl.textContent = usd(totalUplCalc, 2);
      totalUplEl.className =
        'mt-1 text-3xl md:text-4xl font-bold num ' + (totalUplCalc >= 0 ? 'text-emerald-400' : 'text-red-400');
      const totalAbs = positions.reduce((acc, p) => acc + Math.abs(p.notional ?? (p.positionAmt * (binanceMap[p.symbol]?.markPrice ?? p.markPrice ?? 0))), 0);
      const totalNotionalAbsEl = document.getElementById('totalNotionalAbs');
      totalNotionalAbsEl.textContent = usd(totalAbs, 2);

      // 마지막 업데이트
      const updatedAt = src.updatedAt ? new Date(src.updatedAt) : new Date();
      document.getElementById('lastUpdate').textContent = updatedAt.toLocaleString();

      // 기존 행을 맵으로 기억해 blip 애니메이션
      const prev = {};
      [...tbody.querySelectorAll('tr[data-symbol]')].forEach(tr => {
        prev[tr.dataset.symbol] = {
          uplCalc: parseFloat(tr.dataset.uplCalc || '0'),
          mark: parseFloat(tr.dataset.mark || '0'),
        };
      });

      // tbody 새로 그리기
      tbody.innerHTML = '';
      positions.forEach(p => {
        const sym = p.symbol;
        const b = binanceMap[sym];
        const mark = +(b?.markPrice ?? p.markPrice ?? 0);
        const entry = +p.entryPrice;
        const qty = +p.positionAmt;
        const notional = p.notional ?? (qty * mark);
        const uplSource = +p.unrealizedProfit;
        const uplCalcRaw = (mark - entry) * qty; // 음/양 자동
        // 깔끔한 표시값
        const qtyStr = cFmt(qty);
        const entryStr = nf8.format(entry);
        const markStr = mark ? nf8.format(mark) : '—';
        const levStr = p.leverage ? `${p.leverage}×` : '—';
        const isoStr = p.isolated ? 'Isolated' : 'Cross';
        const notionalStr = usd(notional, 2);
        const uplSrcStr = usd(uplSource, 2);
        const uplCalcStr = usd(uplCalcRaw, 2);

        // 변화 감지
        const was = prev[sym];
        const markChanged = was && was.mark !== mark;
        const uplChanged = was && was.uplCalc !== uplCalcRaw;

        const tr = document.createElement('tr');
        tr.dataset.symbol = sym;
        tr.dataset.uplCalc = uplCalcRaw.toString();
        tr.dataset.mark = mark.toString();
        tr.className = "hover:bg-slate-900/50";

        tr.innerHTML = `
          <td class="px-4 py-3 font-semibold">${sym}</td>
          <td class="px-4 py-3 text-right num ${qty < 0 ? 'text-red-300' : 'text-emerald-300'}">${qtyStr}</td>
          <td class="px-4 py-3 text-right num">${entryStr}</td>
          <td class="px-4 py-3 text-right num ${markChanged ? (mark >= (was?.mark ?? mark) ? 'blink' : 'blink-neg') : ''}">
            ${markStr}
          </td>
          <td class="px-4 py-3 text-right">${levStr}</td>
          <td class="px-4 py-3 text-right">${isoStr}</td>
          <td class="px-4 py-3 text-right num">${notionalStr}</td>
          <!-- <td class="px-4 py-3 text-right num ${uplSource>=0 ? 'text-emerald-400' : 'text-red-400'}">${uplSrcStr}</td> -->
          <td class="px-4 py-3 text-right num ${uplChanged ? (uplCalcRaw>= (was?.uplCalc ?? uplCalcRaw) ? 'blink' : 'blink-neg') : ''} ${uplCalcRaw>=0 ? 'text-emerald-400' : 'text-red-400'}">
            ${uplCalcStr}
          </td>
          <!-- <td class="px-4 py-3 text-right text-slate-300 text-xs">
            ${b ? `<div>${pct(parseFloat(b.lastFundingRate || 0))} / Ix ${nf8.format(parseFloat(b.indexPrice || 0))}</div>` : '—'}
          </td>
          <td class="px-4 py-3 text-right text-xs text-slate-400">
            ${p.updatedAt ? new Date(p.updatedAt).toLocaleTimeString() : '—'}
          </td>
          -->
        `;
        tbody.appendChild(tr);
      });
    }

    // 시작
    tick();
    // 페이지 숨김 시 폴링 억제 (백그라운드 CPU 절약)
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        clearTimeout(timer);
      } else {
        tick();
      }
    });
  </script>
</body>
</html>
